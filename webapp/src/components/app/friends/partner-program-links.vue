<template>
    <div 
      class="rounded-[10px] px-4 py-4 -translate-y-[30px] z-10 relative" 
      style="background-image: linear-gradient(178.77deg, rgb(20, 21, 24), rgb(30, 32, 37) 100%);"
    >
      <!-- Background SVG -->
      <svg 
        width="365" 
        height="278" 
        viewBox="0 0 365 278" 
        fill="none" 
        xmlns="http://www.w3.org/2000/svg" 
        class="absolute inset-0 w-full h-full object-cover rounded-[10px]"
      >
        <g clip-path="url(#clip0_1350_774)">
          <rect width="365" height="278" rx="11" fill="white"></rect>
          <rect x="0.5" y="7.5" width="364" height="381" rx="9.5" fill="#131417"></rect>
          <rect x="0.5" y="7.5" width="364" height="381" rx="9.5" fill="url(#paint0_linear_1350_774)"></rect>
          <rect x="0.5" y="7.5" width="364" height="381" rx="9.5" stroke="#2A2B2D"></rect>
          <g filter="url(#filter0_f_1350_774)">
            <rect x="159" y="361" width="47.1625" height="36" fill="#7CFA04"></rect>
          </g>
          <g opacity="0.5" filter="url(#filter1_f_1350_774)">
            <rect x="339" y="211" width="47.1625" height="36" fill="#7CFA04"></rect>
          </g>
          <g filter="url(#filter2_f_1350_774)">
            <rect x="28" y="122" width="47.1625" height="36" fill="#7CFA04"></rect>
          </g>
        </g>
        <defs>
          <filter id="filter0_f_1350_774" x="-22" y="180" width="409.163" height="398" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
            <feFlood flood-opacity="0" result="BackgroundImageFix"></feFlood>
            <feBlend mode="normal" in="SourceGraphic" in2="BackgroundImageFix" result="shape"></feBlend>
            <feGaussianBlur stdDeviation="90.5" result="effect1_foregroundBlur_1350_774"></feGaussianBlur>
          </filter>
          <filter id="filter1_f_1350_774" x="239" y="111" width="247.163" height="236" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
            <feFlood flood-opacity="0" result="BackgroundImageFix"></feFlood>
            <feBlend mode="normal" in="SourceGraphic" in2="BackgroundImageFix" result="shape"></feBlend>
            <feGaussianBlur stdDeviation="50" result="effect1_foregroundBlur_1350_774"></feGaussianBlur>
          </filter>
          <filter id="filter2_f_1350_774" x="-153" y="-59" width="409.163" height="398" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
            <feFlood flood-opacity="0" result="BackgroundImageFix"></feFlood>
            <feBlend mode="normal" in="SourceGraphic" in2="BackgroundImageFix" result="shape"></feBlend>
            <feGaussianBlur stdDeviation="90.5" result="effect1_foregroundBlur_1350_774"></feGaussianBlur>
          </filter>
          <linearGradient id="paint0_linear_1350_774" x1="207.067" y1="7" x2="378.796" y2="240.508" gradientUnits="userSpaceOnUse">
            <stop stop-color="#141518"></stop>
            <stop offset="1" stop-color="#1E2025"></stop>
          </linearGradient>
          <clipPath id="clip0_1350_774">
            <rect width="365" height="278" rx="11" fill="white"></rect>
          </clipPath>
        </defs>
      </svg>
  
      <div class="h-4 relative z-10"></div>
  
      <!-- Referral Link Block -->
      <div class="w-full border border-[#2A2B2D] h-[74px] rounded-[12px] flex flex-col items-center justify-center relative z-10 mt-1">
        <div class="flex items-center gap-x-1">
          <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" width="16" height="16" opacity="0.5" fill="none">
            <rect width="16" height="16" x="0" y="0" fill="rgb(255,255,255)" fill-opacity="0"></rect>
            <path d="M12.2423 10.3573L11.2997 9.41333L12.2423 8.47066C12.8629 7.8446 13.2103 6.99821 13.2084 6.11668C13.2064 5.23516 12.8554 4.39029 12.232 3.76696C11.6087 3.14363 10.7639 2.79259 9.88233 2.79066C9.0008 2.78873 8.15441 3.13606 7.52835 3.75666L6.58502 4.69999L5.64235 3.75733L6.58502 2.81466C7.46023 1.93944 8.64728 1.44775 9.88502 1.44775C11.1228 1.44775 12.3098 1.93944 13.185 2.81466C14.0602 3.68987 14.5519 4.87692 14.5519 6.11466C14.5519 7.3524 14.0602 8.53944 13.185 9.41466L12.2423 10.3573ZM10.3563 12.2427L9.41368 13.1853C8.53847 14.0605 7.35142 14.5522 6.11368 14.5522C4.87594 14.5522 3.6889 14.0605 2.81368 13.1853C1.93847 12.3101 1.44678 11.1231 1.44678 9.88533C1.44678 8.64758 1.93847 7.46054 2.81368 6.58533L3.75702 5.64266L4.69968 6.58666L3.75702 7.52933C3.14493 8.15704 2.80479 9.00062 2.81029 9.87734C2.81578 10.7541 3.16646 11.5933 3.78636 12.2133C4.40627 12.8333 5.24548 13.1841 6.1222 13.1897C6.99892 13.1953 7.84255 12.8553 8.47035 12.2433L9.41368 11.3007L10.3563 12.2427ZM9.88502 5.17133L10.8283 6.11466L6.11368 10.828L5.17102 9.88533L9.88502 5.17133Z" fill="rgb(255,255,255)" fill-rule="nonzero"></path>
          </svg>
          <p class="text-[15px] opacity-50 translate-y-[3px]">Партнерская ссылка</p>
        </div>
        <p class="text-[16px] truncate max-w-full">{{ referralLink || 'Загрузка...' }}</p>
      </div>
  
      <!-- Action Buttons -->
      <div class="flex justify-between space-x-3 mt-3 relative z-10">
        <button 
          @click="shareReferral"
          class="gap-2 whitespace-nowrap text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive text-primary-foreground shadow-xs hover:bg-primary/90 px-4 py-2 has-[>svg]:px-3 h-[40px] box-border border border-white/30 rounded-[10px] backdrop-blur-[181.9px] bg-gradient-to-b from-[#B3F106] to-[#5EFF03] flex items-center justify-center flex-1"
          data-slot="button"
        >
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none">
            <rect width="24" height="24" x="0" y="0" fill="rgb(255,255,255)" fill-opacity="0"></rect>
            <path d="M13.803 5.33301C13.803 3.49301 15.303 2.00001 17.151 2.00001C17.5898 1.99883 18.0245 2.08412 18.4303 2.251C18.8361 2.41788 19.2051 2.66309 19.5161 2.97262C19.8271 3.28214 20.0741 3.64991 20.2429 4.05492C20.4117 4.45992 20.4991 4.89423 20.5 5.33301C20.5 7.17401 19 8.66701 17.151 8.66701C16.7076 8.66734 16.2686 8.57964 15.8593 8.40901C15.4501 8.23838 15.0788 7.98822 14.767 7.67301L10.132 10.829C10.2608 11.472 10.1975 12.1387 9.95 12.746L15.032 16.086C15.6307 15.5981 16.3797 15.3321 17.152 15.333C17.5908 15.332 18.0255 15.4174 18.4312 15.5844C18.837 15.7514 19.2059 15.9967 19.5168 16.3063C19.8277 16.6159 20.0746 16.9838 20.2433 17.3888C20.412 17.7939 20.4992 18.2282 20.5 18.667C20.5 20.507 19 22 17.151 22C16.7123 22.0011 16.2777 21.9157 15.872 21.7487C15.4663 21.5818 15.0975 21.3366 14.7866 21.0271C14.4757 20.7175 14.2288 20.3498 14.06 19.9449C13.8913 19.5399 13.8039 19.1057 13.803 18.667C13.8022 18.1996 13.9007 17.7374 14.092 17.311L9.05 14C8.43922 14.5306 7.65706 14.8222 6.848 14.821C6.40922 14.8221 5.97453 14.7366 5.56877 14.5696C5.16301 14.4026 4.79413 14.1573 4.48321 13.8477C4.17229 13.5381 3.92543 13.1702 3.75673 12.7652C3.58802 12.3601 3.50079 11.9258 3.5 11.487C3.50092 11.0483 3.58825 10.6141 3.75701 10.2092C3.92578 9.80421 4.17266 9.43648 4.48356 9.12697C4.79447 8.81746 5.1633 8.57223 5.569 8.40529C5.97469 8.23834 6.4093 8.15296 6.848 8.15401C7.912 8.15401 8.858 8.64701 9.471 9.41501L13.964 6.35601C13.8568 6.02561 13.8025 5.68036 13.803 5.33301Z" fill="rgb(0,0,0)" fill-rule="evenodd"></path>
          </svg>
          <p class="text-[18px] font-semibold text-black">Пригласить друга</p>
        </button>
  
        <button 
          @click="copyReferral"
          class="gap-2 whitespace-nowrap text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive text-primary-foreground shadow-xs hover:bg-primary/90 px-4 py-2 has-[>svg]:px-3 w-[40px] h-[40px] box-border border border-white/30 rounded-[10px] backdrop-blur-[181.9px] bg-gradient-to-b from-[#B3F106] to-[#5EFF03] flex items-center justify-center"
          data-slot="button"
        >
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" class="scale-[1.4]">
            <rect width="24" height="24" x="0" y="0" fill="rgb(255,255,255)" fill-opacity="0"></rect>
            <path d="M15.24 2L11.346 2C9.582 2 8.184 2 7.091 2.148C5.965 2.3 5.054 2.62 4.336 3.341C3.617 4.062 3.298 4.977 3.147 6.107C3 7.205 3 8.608 3 10.379L3 16.217C3 17.725 3.92 19.017 5.227 19.559C5.16 18.649 5.16 17.374 5.16 16.312L5.16 11.302C5.16 10.021 5.16 8.916 5.278 8.032C5.405 7.084 5.691 6.176 6.425 5.439C7.159 4.702 8.064 4.415 9.008 4.287C9.888 4.169 10.988 4.169 12.265 4.169L15.335 4.169C16.611 4.169 17.709 4.169 18.59 4.287C18.3261 3.61329 17.8653 3.03474 17.2678 2.62678C16.6702 2.21883 15.9635 2.00041 15.24 2Z" fill="rgb(0,0,0)" fill-rule="nonzero"></path>
            <path d="M6.6001 11.397C6.6001 8.67101 6.6001 7.30801 7.4441 6.46101C8.2871 5.61401 9.6441 5.61401 12.3601 5.61401L15.2401 5.61401C17.9551 5.61401 19.3131 5.61401 20.1571 6.46101C21.0011 7.30801 21.0001 8.67101 21.0001 11.397L21.0001 16.217C21.0001 18.943 21.0001 20.306 20.1571 21.153C19.3131 22 17.9551 22 15.2401 22L12.3601 22C9.6451 22 8.2871 22 7.4441 21.153C6.6001 20.306 6.6001 18.943 6.6001 16.217L6.6001 11.397Z" fill="rgb(0,0,0)" fill-rule="nonzero"></path>
          </svg>
        </button>
      </div>
  
      <!-- Stats Cards -->
      <div 
        class="flex mt-3 box-border rounded-[12px] p-4 relative z-10" 
        style="background-image: linear-gradient(178.77deg, rgb(20, 21, 24), rgb(30, 32, 37) 100%);"
      >
        <!-- Partners Card -->
        <div class="flex flex-col h-[66px] justify-center items-center -space-y-2 flex-1 rounded-[12px] p-3 relative">
          <svg width="162" height="66" viewBox="0 0 162 66" fill="none" xmlns="http://www.w3.org/2000/svg" class="absolute inset-0 w-full h-full rounded-[12px]">
            <g clip-path="url(#clip0_1350_885)">
              <rect width="162" height="66" rx="12" fill="white"></rect>
              <rect x="0.5" y="0.5" width="161" height="65" rx="11.5" fill="#131417"></rect>
              <rect x="0.5" y="0.5" width="161" height="65" rx="11.5" fill="url(#paint0_linear_1350_885)"></rect>
              <rect x="0.5" y="0.5" width="161" height="65" rx="11.5" stroke="#2A2B2D"></rect>
              <g opacity="0.02">
                <path d="M137 37.1666C145.653 37.1666 152.667 30.1524 152.667 21.4999C152.667 12.8475 145.653 5.83325 137 5.83325C128.348 5.83325 121.333 12.8475 121.333 21.4999C121.333 30.1524 128.348 37.1666 137 37.1666Z" fill="white"></path>
                <path d="M168.333 66.5417C168.333 76.2747 168.333 84.1667 137 84.1667C105.667 84.1667 105.667 76.2747 105.667 66.5417C105.667 56.8088 119.696 48.9167 137 48.9167C154.304 48.9167 168.333 56.8088 168.333 66.5417Z" fill="white"></path>
              </g>
            </g>
            <defs>
              <linearGradient id="paint0_linear_1350_885" x1="91.9038" y1="-7.80816e-7" x2="108.353" y2="57.4558" gradientUnits="userSpaceOnUse">
                <stop stop-color="#141518"></stop>
                <stop offset="1" stop-color="#1E2025"></stop>
              </linearGradient>
              <clipPath id="clip0_1350_885">
                <rect width="162" height="66" rx="12" fill="white"></rect>
              </clipPath>
            </defs>
          </svg>
          <div v-if="isLoading" class="relative z-10 animate-pulse">
            <div class="w-8 h-6 bg-gray-600 rounded mb-1"></div>
            <div class="w-16 h-4 bg-gray-600 rounded"></div>
          </div>
          <div v-else class="relative z-10 text-center">
            <p class="text-[24px] font-semibold">{{ partnersCount }}</p>
            <p class="text-[16px] opacity-50">Партнеров</p>
          </div>
        </div>
  
        <!-- Earnings Card -->
        <div class="flex flex-col h-[66px] justify-center items-center -space-y-2 flex-1 rounded-[12px] p-3 ml-3 relative">
          <svg width="162" height="66" viewBox="0 0 162 66" fill="none" xmlns="http://www.w3.org/2000/svg" class="absolute inset-0 w-full h-full object-cover rounded-[12px]">
            <g clip-path="url(#clip0_1350_895)">
              <rect width="162" height="66" rx="12" fill="white"></rect>
              <rect x="0.5" y="0.5" width="161" height="65" rx="11.5" fill="#131417"></rect>
              <rect x="0.5" y="0.5" width="161" height="65" rx="11.5" fill="url(#paint0_linear_1350_895)"></rect>
              <rect x="0.5" y="0.5" width="161" height="65" rx="11.5" stroke="#2A2B2D"></rect>
              <g opacity="0.02">
                <path d="M138 69C135.388 69 133.152 68.0706 131.293 66.2118C129.434 64.3529 128.503 62.1157 128.5 59.5C128.497 56.8843 129.428 54.6487 131.293 52.793C133.158 50.9373 135.394 50.0063 138 50C140.606 49.9937 142.843 50.9247 144.712 52.793C146.58 54.6613 147.509 56.897 147.5 59.5C147.491 62.103 146.561 64.3403 144.712 66.2118C142.862 68.0833 140.625 69.0127 138 69ZM116.031 26.25H159.969L169.469 7.25H106.531L116.031 26.25ZM120.9 92.75H155.1C162.225 92.75 168.281 90.2768 173.269 85.3305C178.256 80.3842 180.75 74.3073 180.75 67.1C180.75 64.0917 180.235 61.1625 179.206 58.3125C178.177 55.4625 176.713 52.8896 174.812 50.5938L162.463 35.75H113.538L101.188 50.5938C99.2875 52.8896 97.8229 55.4625 96.7938 58.3125C95.7646 61.1625 95.25 64.0917 95.25 67.1C95.25 74.3042 97.7248 80.381 102.674 85.3305C107.624 90.28 113.699 92.7532 120.9 92.75Z" fill="white"></path>
              </g>
            </g>
            <defs>
              <linearGradient id="paint0_linear_1350_895" x1="145" y1="33" x2="151.324" y2="196.225" gradientUnits="userSpaceOnUse">
                <stop stop-color="#141518"></stop>
                <stop offset="1" stop-color="#D2FF55"></stop>
              </linearGradient>
              <clipPath id="clip0_1350_895">
                <rect width="162" height="66" rx="12" fill="white"></rect>
              </clipPath>
            </defs>
          </svg>
          <div v-if="isLoading" class="relative z-10 animate-pulse">
            <div class="w-12 h-6 bg-gray-600 rounded mb-1"></div>
            <div class="w-20 h-4 bg-gray-600 rounded"></div>
          </div>
          <div v-else class="relative z-10 text-center">
            <p class="text-[24px] font-semibold">{{ formattedEarnings }}₽</p>
            <p class="text-[16px] opacity-50">Заработано</p>
          </div>
        </div>
      </div>
      
      <!-- Временная отладочная информация (убрать в продакшене) -->
      <div v-if="error" class="mt-3 p-3 bg-red-900/20 border border-red-500/30 rounded-lg relative z-10">
        <p class="text-red-400 text-sm">❌ {{ error }}</p>
        <button 
          @click="refreshReferralData"
          class="mt-2 px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm"
        >
          🔄 Повторить
        </button>
      </div>
      
      <!-- Подробная отладочная панель -->
    </div>
  </template>
  
<script setup>
import { computed, onMounted } from 'vue'
import { useTelegramStore } from '../../../stores/telegram.js'
import { useReferral } from '../../../composables/useReferral.js'
import TelegramDebug from '../../TelegramDebug.vue'

// Stores и композаблы
const telegramStore = useTelegramStore()
const {
  referralData,
  isLoading,
  error,
  formattedEarnings,
  loadReferralData,
  shareReferralLink,
  copyReferralLink,
  refreshReferralData,
  getCurrentReferralLink
} = useReferral()

// Вычисляемые свойства для удобного доступа
const referralLink = computed(() => {
  // Always ensure we have a link
  return referralData.value.link || getCurrentReferralLink()
})
const partnersCount = computed(() => referralData.value.partnersCount)

// Методы
const shareReferral = () => shareReferralLink()
const copyReferral = () => copyReferralLink()

// Отладочная информация (можно убрать в продакшене)
const debugInfo = computed(() => ({
  telegramId: telegramStore.userId,
  isInitialized: telegramStore.isInitialized,
  user: telegramStore.user,
  link: referralData.value.link,
  partners: referralData.value.partnersCount,
  earnings: referralData.value.totalEarnings,
  isLoading: isLoading.value,
  error: error.value
}))

// Жизненный цикл
onMounted(async () => {
  console.log('🚀 Монтирование компонента partner-program-links')
  
  // Сразу генерируем ссылку, если возможно
  if (telegramStore.userId || telegramStore.user?.id || telegramStore.initDataUnsafe?.user?.id) {
    console.log('✅ Telegram ID доступен сразу, генерируем ссылку')
    referralData.value.link = getCurrentReferralLink()
  }
  
  // Ждем инициализации Telegram store (с таймаутом)
  let attempts = 0
  const maxAttempts = 30 // 3 секунды максимум
  
  while (!telegramStore.isInitialized && attempts < maxAttempts) {
    console.log(`⏳ Ожидание инициализации Telegram (попытка ${attempts + 1}/${maxAttempts})`)
    await new Promise(resolve => setTimeout(resolve, 100))
    attempts++
  }
  
  if (!telegramStore.isInitialized) {
    console.warn('⚠️ Telegram не инициализирован за 3 секунды, продолжаем с fallback данными')
  }
  
  // Загружаем данные (это обновит ссылку, если API доступен)
  console.log('📊 Загрузка реферальных данных...')
  await loadReferralData()
  
  // Дополнительная проверка - убеждаемся, что ссылка есть
  if (!referralData.value.link) {
    console.log('🔧 Принудительная генерация ссылки как fallback')
    referralData.value.link = getCurrentReferralLink()
  }
  
  console.log('✅ Компонент partner-program-links полностью загружен')
})
</script>