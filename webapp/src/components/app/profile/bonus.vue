<template>
    <div class="h-[131px] w-full border-b px-[10px] pt-[15px] border-[#272727] bg-[#131417] rounded-[14px] mt-4 relative overflow-hidden flex flex-col">
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <svg viewBox="0 0 26 26" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="26" height="26" fill="none" customFrame="#000000">
            <rect id="tabler:gift-filled" width="26" height="26" x="0" y="0" fill="rgb(255,255,255)" fill-opacity="0"></rect>
            <path id="Vector" d="M11.9167 15.1667L11.9167 23.8333L7.58341 23.8333C6.72146 23.8333 5.89481 23.4909 5.28532 22.8814C4.67582 22.2719 4.33341 21.4453 4.33341 20.5833L4.33341 16.25C4.33341 15.9627 4.44755 15.6871 4.65072 15.484C4.85388 15.2808 5.12943 15.1667 5.41675 15.1667L11.9167 15.1667ZM20.5834 15.1667C20.8707 15.1667 21.1463 15.2808 21.3494 15.484C21.5526 15.6871 21.6667 15.9627 21.6667 16.25L21.6667 20.5833C21.6667 21.4453 21.3243 22.2719 20.7148 22.8814C20.1054 23.4909 19.2787 23.8333 18.4167 23.8333L14.0834 23.8333L14.0834 15.1667L20.5834 15.1667ZM17.8751 2.16665C18.5148 2.16652 19.1442 2.32825 19.7046 2.63678C20.265 2.94532 20.7382 3.39063 21.0802 3.93126C21.4222 4.47189 21.6219 5.09026 21.6606 5.72881C21.6993 6.36736 21.5758 7.00532 21.3017 7.58332L21.6667 7.58332C22.2414 7.58332 22.7925 7.81159 23.1988 8.21792C23.6051 8.62425 23.8334 9.17535 23.8334 9.74998L23.8334 10.8333C23.8334 11.408 23.6051 11.9591 23.1988 12.3654C22.7925 12.7717 22.2414 13 21.6667 13L14.0834 13L14.0834 7.58332L11.9167 7.58332L11.9167 13L4.33341 13C3.75878 13 3.20768 12.7717 2.80135 12.3654C2.39502 11.9591 2.16675 11.408 2.16675 10.8333L2.16675 9.74998C2.16675 9.17535 2.39502 8.62425 2.80135 8.21792C3.20768 7.81159 3.75878 7.58332 4.33341 7.58332L4.6985 7.58332C4.45787 7.0754 4.33317 6.52035 4.33341 5.95832C4.33341 3.86423 6.031 2.16665 8.10666 2.16665C10.0079 2.13415 11.6947 3.34965 12.8527 5.34515L13.0001 5.6084C14.1192 3.5349 15.7734 2.2349 17.6487 2.16882L17.8751 2.16665ZM8.12508 4.33332C7.6941 4.33332 7.28078 4.50452 6.97603 4.80927C6.67129 5.11402 6.50008 5.52734 6.50008 5.95832C6.50008 6.3893 6.67129 6.80262 6.97603 7.10737C7.28078 7.41211 7.6941 7.58332 8.12508 7.58332L11.53 7.58332C10.7272 5.51957 9.41858 4.31165 8.12508 4.33332ZM17.8567 4.33332C16.5783 4.31165 15.2729 5.52065 14.4702 7.58332L17.8751 7.58332C18.3061 7.58088 18.7184 7.40733 19.0214 7.10086C19.3245 6.79438 19.4933 6.38009 19.4909 5.94911C19.4884 5.51813 19.3149 5.10578 19.0084 4.80276C18.7019 4.49974 18.2876 4.33088 17.8567 4.33332Z" fill="rgb(0,0,0)" fill-rule="nonzero"></path>
            <path id="Vector" d="M11.9167 15.1667L11.9167 23.8333L7.58341 23.8333C6.72146 23.8333 5.89481 23.4909 5.28532 22.8814C4.67582 22.2719 4.33341 21.4453 4.33341 20.5833L4.33341 16.25C4.33341 15.9627 4.44755 15.6871 4.65072 15.484C4.85388 15.2808 5.12943 15.1667 5.41675 15.1667L11.9167 15.1667ZM20.5834 15.1667C20.8707 15.1667 21.1463 15.2808 21.3494 15.484C21.5526 15.6871 21.6667 15.9627 21.6667 16.25L21.6667 20.5833C21.6667 21.4453 21.3243 22.2719 20.7148 22.8814C20.1054 23.4909 19.2787 23.8333 18.4167 23.8333L14.0834 23.8333L14.0834 15.1667L20.5834 15.1667ZM17.8751 2.16665C18.5148 2.16652 19.1442 2.32825 19.7046 2.63678C20.265 2.94532 20.7382 3.39063 21.0802 3.93126C21.4222 4.47189 21.6219 5.09026 21.6606 5.72881C21.6993 6.36736 21.5758 7.00532 21.3017 7.58332L21.6667 7.58332C22.2414 7.58332 22.7925 7.81159 23.1988 8.21792C23.6051 8.62425 23.8334 9.17535 23.8334 9.74998L23.8334 10.8333C23.8334 11.408 23.6051 11.9591 23.1988 12.3654C22.7925 12.7717 22.2414 13 21.6667 13L14.0834 13L14.0834 7.58332L11.9167 7.58332L11.9167 13L4.33341 13C3.75878 13 3.20768 12.7717 2.80135 12.3654C2.39502 11.9591 2.16675 11.408 2.16675 10.8333L2.16675 9.74998C2.16675 9.17535 2.39502 8.62425 2.80135 8.21792C3.20768 7.81159 3.75878 7.58332 4.33341 7.58332L4.6985 7.58332C4.45787 7.0754 4.33317 6.52035 4.33341 5.95832C4.33341 3.86423 6.031 2.16665 8.10666 2.16665C10.0079 2.13415 11.6947 3.34965 12.8527 5.34515L13.0001 5.6084C14.1192 3.5349 15.7734 2.2349 17.6487 2.16882L17.8751 2.16665ZM8.12508 4.33332C7.6941 4.33332 7.28078 4.50452 6.97603 4.80927C6.67129 5.11402 6.50008 5.52734 6.50008 5.95832C6.50008 6.3893 6.67129 6.80262 6.97603 7.10737C7.28078 7.41211 7.6941 7.58332 8.12508 7.58332L11.53 7.58332C10.7272 5.51957 9.41858 4.31165 8.12508 4.33332ZM17.8567 4.33332C16.5783 4.31165 15.2729 5.52065 14.4702 7.58332L17.8751 7.58332C18.3061 7.58088 18.7184 7.40733 19.0214 7.10086C19.3245 6.79438 19.4933 6.38009 19.4909 5.94911C19.4884 5.51813 19.3149 5.10578 19.0084 4.80276C18.7019 4.49974 18.2876 4.33088 17.8567 4.33332Z" fill="rgb(144,247,5)" fill-rule="nonzero"></path>
          </svg>
          <p class="text-[20px] font-semibold ml-3">Бонусная акция</p>
        </div>
        <div class="w-[90px] h-[39px] relative overflow-hidden box-border border-[0.55px] border-[rgba(33,32,34,1)] rounded-[72px] flex items-center space-x-1 justify-center" style="backdrop-filter: blur(11.0317px);">
          <div class="relative flex items-center justify-center" style="box-shadow: rgba(94, 255, 3, 0.4) 0px 0px 17.976px 0px;">
            <div class="absolute w-[15px] h-[15px] rounded-full bg-[rgba(144,247,5,1)] opacity-20"></div>
            <div class="w-[9px] h-[9px] rounded-full bg-[rgba(144,247,5,1)]"></div>
          </div>
          <div class="flex flex-col items-center -space-y-2">
            <p class="text-[12px] opacity-40">Онлайн</p>
            <p class="text-[16px] font-semibold">{{ currentOnline }}</p>
          </div>
          <div class="absolute -bottom-14 right-2 w-[37.51px] h-[28.68px] opacity-100" style="filter: blur(40.8175px); background: linear-gradient(rgb(217, 217, 217) 0%, rgb(99, 102, 104) 100%);"></div>
        </div>
      </div>
      <div class="border-b border-[#272727] rounded-[13px] bg-[#181A1D] h-[52px] w-full mt-3 flex justify-between pr-[7px] pl-[11px] pt-[8px]">
        <div class="flex flex-col">
          <div class="flex items-center">
            <svg viewBox="0 0 14.1804 14.1804" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14.18042" height="14.18042" fill="none" class="-translate-y-[1px]">
              <rect id="lets-icons:pined-fill" width="14.180327" height="14.180327" x="0" y="0" fill="rgb(255,255,255)" fill-opacity="0"></rect>
              <g id="Group">
                <path id="Union" d="M4.72698 2.76508L4.72698 2.63568C4.72698 2.38162 4.72698 2.25518 4.76538 2.15415C4.79496 2.07594 4.8408 2.0049 4.89988 1.94572C4.95895 1.88654 5.02992 1.84058 5.10808 1.81087C5.21029 1.77246 5.33732 1.77246 5.5908 1.77246L8.59112 1.77246C8.84518 1.77246 8.97162 1.77246 9.07266 1.81087C9.15087 1.84044 9.22191 1.88629 9.28109 1.94536C9.34026 2.00444 9.38623 2.0754 9.41594 2.15356C9.45434 2.25518 9.45434 2.38222 9.45434 2.63569L9.45434 2.76449C9.45434 3.29035 9.45435 3.55327 9.48211 3.81029C9.54593 4.3911 9.71668 4.95535 9.98611 5.47412C10.1049 5.70278 10.2508 5.92139 10.5427 6.35921L11.156 7.27915C11.2307 7.39131 11.2774 7.51979 11.2921 7.65376C11.3068 7.78774 11.2891 7.92329 11.2405 8.04898C11.1918 8.17467 11.1136 8.28683 11.0126 8.37599C10.9115 8.46515 10.7905 8.5287 10.6597 8.56129C9.68046 8.80613 8.68236 8.94865 7.68115 8.98884L7.68115 11.226L10.6353 11.226L10.6353 12.4077L7.10029 12.4077L7.0903 12.4078L7.08031 12.4077L3.54516 12.4077L3.54516 11.226L6.49945 11.226L6.49945 8.98879C5.49868 8.94852 4.50102 8.80603 3.52224 8.56129C3.39146 8.5287 3.27043 8.46515 3.16935 8.37599C3.06828 8.28683 2.99012 8.17467 2.94146 8.04898C2.89281 7.92329 2.87508 7.78774 2.88978 7.65376C2.90448 7.51979 2.95118 7.39131 3.02593 7.27915L3.63923 6.35921C3.93111 5.92198 4.07646 5.70337 4.19581 5.47412C4.46509 4.95522 4.63578 4.39086 4.69921 3.8097C4.72698 3.55327 4.72698 3.29094 4.72698 2.76508Z" fill="rgb(255,255,255)" fill-opacity="0.5" fill-rule="evenodd"></path>
              </g>
            </svg>
            <p class="text-[13px] opacity-50 ml-1">Закрепленно・</p>
            <p class="text-[13px] text-[#90F705]">Гендиректор</p>
          </div>
          <p class="text-[15px] font-semibold">1500₽ + За приглашения друга</p>
        </div>
        <div>
          <button data-slot="button" class="inline-flex items-center justify-center gap-2 whitespace-nowrap font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive text-primary-foreground hover:bg-primary/90 h-9 px-4 py-2 has-[&>svg]:px-3 box-border border border-white/30 rounded-[12.18px] shadow-[0_0_25px_0_rgba(94,255,3,0.25)] bg-gradient-to-b from-[#b3f106] to-[#5eff03] text-[16px]">Перейти</button>
        </div>
      </div>
      <div class="absolute top-0 left-0 w-[42px] h-[42px] opacity-40" style="filter: blur(22.2px); background: rgb(144, 247, 5);"></div>
    </div>
  </template>
  
<script setup>
import { ref, onMounted, onUnmounted } from 'vue'
import { useApi } from '../../../composables/useApi.js'

// API композабл
const api = useApi()

// Реактивные данные
const currentOnline = ref('...')
const isLoading = ref(false)
const error = ref(null)

// Интервал для обновления данных
let updateInterval = null

// Функция загрузки онлайна
const fetchOnline = async () => {
  try {
    isLoading.value = true
    error.value = null
    
    const response = await api.getOnline()
    currentOnline.value = response.online
    
    // Логируем расширенную информацию из нового API
    const timeToNext = response.time_to_next_update || 0
    const serverUpdateInterval = response.update_interval || 300
    
    console.log('📊 Онлайн обновлен:', response.online)
    console.log(`⏰ До следующего обновления: ${timeToNext}с (серверный интервал: ${serverUpdateInterval}с)`)
    
    // Если онлайн скоро обновится на сервере, можно подстроить клиентский интервал
    if (timeToNext > 0 && timeToNext < 60) {
      console.log('🔄 Скоро серверное обновление, подстраиваем интервал клиента')
    }
    
  } catch (err) {
    console.error('❌ Ошибка получения онлайна:', err)
    error.value = err.message
    // В случае ошибки показываем предыдущее значение или placeholder
    if (currentOnline.value === '...') {
      currentOnline.value = '—'
    }
  } finally {
    isLoading.value = false
  }
}

// Запуск обновления онлайна
const startOnlineUpdates = () => {
  // Сразу загружаем данные
  fetchOnline()
  
  // Затем обновляем каждые 30 секунд
  updateInterval = setInterval(fetchOnline, 30000)
}

// Остановка обновления
const stopOnlineUpdates = () => {
  if (updateInterval) {
    clearInterval(updateInterval)
    updateInterval = null
  }
}

// Жизненный цикл компонента
onMounted(() => {
  console.log('🔄 Запуск обновления онлайна...')
  startOnlineUpdates()
})

onUnmounted(() => {
  console.log('⏹️ Остановка обновления онлайна...')
  stopOnlineUpdates()
})
</script>